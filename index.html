<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document Signing Portal</title>

    <!-- Dropbox Sign (HelloSign) Embedded Library v2 -->
    <script src="https://cdn.hellosign.com/public/js/embedded/v2.0.0/embedded.production.min.js"></script>

    <style>
      /* CSS Reset and Base Styles
           This ensures consistent rendering across browsers */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Oxygen, Ubuntu, Cantarell, sans-serif;
        background-color: #f5f7fa;
        color: #2c3e50;
        line-height: 1.6;
        min-height: 100vh;
      }

      /* Container and Layout Styles
           Using max-width for better readability on large screens */
      .container {
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
      }

      /* Header Styles */
      .header {
        text-align: center;
        margin-bottom: 40px;
        padding: 40px 0;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 10px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      }

      .header h1 {
        font-size: 2.5em;
        margin-bottom: 10px;
        font-weight: 700;
      }

      .header p {
        font-size: 1.1em;
        opacity: 0.9;
      }

      /* Card Styles for Different Sections */
      .card {
        background: white;
        border-radius: 10px;
        padding: 30px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
        margin-bottom: 20px;
        transition: transform 0.2s, box-shadow 0.2s;
      }

      .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.12);
      }

      /* Form Styles */
      .form-group {
        margin-bottom: 20px;
      }

      .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #34495e;
        font-size: 0.95em;
      }

      .form-group input {
        width: 100%;
        padding: 12px 16px;
        border: 2px solid #e1e8ed;
        border-radius: 6px;
        font-size: 16px;
        transition: border-color 0.3s, box-shadow 0.3s;
        background-color: #fafbfc;
      }

      .form-group input:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        background-color: white;
      }

      .form-group input:invalid {
        border-color: #e74c3c;
      }

      .form-group .helper-text {
        font-size: 0.85em;
        color: #7f8c8d;
        margin-top: 5px;
      }

      /* Button Styles */
      .btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 12px 30px;
        border: none;
        border-radius: 6px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
        display: inline-block;
        text-decoration: none;
        margin-right: 10px;
        margin-top: 10px;
      }

      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
      }

      .btn:active {
        transform: translateY(0);
      }

      .btn:disabled {
        background: #95a5a6;
        cursor: not-allowed;
        transform: none;
      }

      .btn-secondary {
        background: #95a5a6;
      }

      .btn-success {
        background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
      }

      /* Status Display Styles */
      .status-container {
        display: none;
        text-align: center;
        padding: 20px;
        background-color: #f8f9fa;
        border-radius: 8px;
        margin-top: 20px;
      }

      .status-container.active {
        display: block;
      }

      .status-icon {
        font-size: 48px;
        margin-bottom: 15px;
      }

      .status-message {
        font-size: 1.2em;
        color: #2c3e50;
        margin-bottom: 10px;
      }

      .status-details {
        color: #7f8c8d;
        font-size: 0.9em;
      }

      /* Loading Spinner */
      .spinner {
        display: inline-block;
        width: 50px;
        height: 50px;
        border: 3px solid rgba(102, 126, 234, 0.3);
        border-radius: 50%;
        border-top-color: #667eea;
        animation: spin 1s ease-in-out infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      /* Progress Bar */
      .progress-bar {
        width: 100%;
        height: 4px;
        background-color: #e1e8ed;
        border-radius: 2px;
        overflow: hidden;
        margin-top: 20px;
      }

      .progress-bar-fill {
        height: 100%;
        background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
        width: 0%;
        transition: width 0.3s ease;
      }

      /* Signing Container for Embedded iFrame */
      .signing-container {
        display: none;
        min-height: 600px;
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
        overflow: hidden;
      }

      .signing-container.active {
        display: block;
      }

      /* Error and Success Messages */
      .alert {
        padding: 15px 20px;
        border-radius: 6px;
        margin-bottom: 20px;
        display: none;
      }

      .alert.active {
        display: block;
      }

      .alert-error {
        background-color: #fee;
        color: #c33;
        border: 1px solid #fcc;
      }

      .alert-success {
        background-color: #efe;
        color: #3c3;
        border: 1px solid #cfc;
      }

      .alert-info {
        background-color: #e6f3ff;
        color: #0066cc;
        border: 1px solid #b3d9ff;
      }

      /* Responsive Design */
      @media (max-width: 768px) {
        .container {
          padding: 10px;
        }

        .header h1 {
          font-size: 2em;
        }

        .card {
          padding: 20px;
        }

        .btn {
          width: 100%;
          margin-right: 0;
        }
      }

      /* Accessibility Improvements */
      .visually-hidden {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border: 0;
      }

      /* Tooltip Styles */
      .tooltip {
        position: relative;
        display: inline-block;
        cursor: help;
        color: #667eea;
        margin-left: 5px;
      }

      .tooltip .tooltip-text {
        visibility: hidden;
        width: 200px;
        background-color: #2c3e50;
        color: white;
        text-align: center;
        border-radius: 6px;
        padding: 8px 12px;
        position: absolute;
        z-index: 1;
        bottom: 125%;
        left: 50%;
        margin-left: -100px;
        opacity: 0;
        transition: opacity 0.3s;
        font-size: 0.85em;
      }

      .tooltip:hover .tooltip-text {
        visibility: visible;
        opacity: 1;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- Header Section -->
      <div class="header">
        <h1>üìù Document Signing Portal</h1>
        <p>Sign your documents securely and efficiently</p>
      </div>

      <!-- Alert Messages -->
      <div id="alertContainer"></div>

      <!-- Signer Information Form -->
      <div id="signerForm" class="card">
        <h2>Signer Information</h2>
        <p style="color: #7f8c8d; margin-bottom: 20px">
          Please provide your information to begin the signing process
        </p>

        <form id="signingForm" onsubmit="handleFormSubmit(event)">
          <div class="form-group">
            <label for="name">
              Full Name *
              <span class="tooltip"
                >‚ÑπÔ∏è
                <span class="tooltip-text"
                  >Your legal name as it should appear on the document</span
                >
              </span>
            </label>
            <input
              type="text"
              id="name"
              name="name"
              required
              minlength="2"
              placeholder="John Doe"
              aria-describedby="name-helper"
            />
            <div id="name-helper" class="helper-text">
              Enter your full legal name
            </div>
          </div>

          <div class="form-group">
            <label for="email">
              Email Address *
              <span class="tooltip"
                >‚ÑπÔ∏è
                <span class="tooltip-text"
                  >We'll use this to send you a copy of the signed
                  document</span
                >
              </span>
            </label>
            <input
              type="email"
              id="email"
              name="email"
              required
              placeholder="john.doe@example.com"
              aria-describedby="email-helper"
            />
            <div id="email-helper" class="helper-text">
              Enter a valid email address
            </div>
          </div>

          <div class="form-group">
            <label for="phone">
              Phone Number (Optional)
              <span class="tooltip"
                >‚ÑπÔ∏è
                <span class="tooltip-text"
                  >We may use this for SMS verification if enabled</span
                >
              </span>
            </label>
            <input
              type="tel"
              id="phone"
              name="phone"
              placeholder="(555) 123-4567"
              pattern="[0-9]{3}-?[0-9]{3}-?[0-9]{4}"
              aria-describedby="phone-helper"
            />
            <div id="phone-helper" class="helper-text">
              10-digit phone number (optional)
            </div>
          </div>

          <button type="submit" class="btn" id="submitBtn">Next ‚Üí</button>
        </form>
      </div>

      <!-- Signing Container -->
      <div id="signingContainer" class="signing-container"></div>

      <!-- Status Display -->
      <div id="statusContainer" class="card status-container">
        <div id="statusContent">
          <!-- Status content will be dynamically inserted here -->
        </div>
        <div class="progress-bar">
          <div class="progress-bar-fill" id="progressBar"></div>
        </div>
      </div>
    </div>

    <script>
      // Configuration and State Management
      // This object holds all the configuration and state for our application
      const config = {
        backendUrl: "http://localhost:8000", // Your FastAPI backend URL
        clientId: "", // Will be populated from backend response or environment
        pollInterval: 3000, // Poll status every 3 seconds
        maxPollAttempts: 100, // Maximum polling attempts before timeout
      };

      // Application state to track the current session
      let appState = {
        sessionId: null,
        envelopeId: null,
        signingUrl: null,
        pollCount: 0,
        statusPoller: null,
        hellosignClient: null,
      };

      /**
       * Display an alert message to the user
       * This provides feedback for various actions and errors
       */
      function showAlert(message, type = "info") {
        const alertContainer = document.getElementById("alertContainer");
        const alert = document.createElement("div");
        alert.className = `alert alert-${type} active`;
        alert.textContent = message;

        // Remove any existing alerts
        alertContainer.innerHTML = "";
        alertContainer.appendChild(alert);

        // Auto-hide success messages after 5 seconds
        if (type === "success") {
          setTimeout(() => {
            alert.classList.remove("active");
          }, 5000);
        }
      }

      /**
       * Handle form submission
       * This is the entry point for the signing process
       */
      async function handleFormSubmit(event) {
        event.preventDefault();

        // Extract form data
        const formData = new FormData(event.target);
        const signerInfo = {
          name: formData.get("name").trim(),
          email: formData.get("email").trim(),
          phone: formData.get("phone").trim() || null,
          role_name: "Hiring Manager", // This should match your Dropbox Sign template role
        };

        // Validate the data
        if (!validateSignerInfo(signerInfo)) {
          return;
        }

        // Disable the form while processing
        setFormEnabled(false);
        showAlert("Creating signing session...", "info");

        try {
          // Create signing session with backend
          const response = await fetch(
            `${config.backendUrl}/create-signing-session`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(signerInfo),
            }
          );

          if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || "Failed to create signing session");
          }

          const sessionData = await response.json();

          // Store session information
          appState.sessionId = sessionData.session_id;
          appState.envelopeId = sessionData.envelope_id;
          appState.signingUrl = sessionData.signing_url;

          // Use client_id returned from the backend
          config.clientId = sessionData.client_id;
          console.log("Client ID set from backend response:", config.clientId);

          showAlert("Signing session created successfully!", "success");

          // Proceed to signing
          await initializeEmbeddedSigning();
        } catch (error) {
          console.error("Error creating signing session:", error);
          showAlert(`Error: ${error.message}`, "error");
          setFormEnabled(true);
        }
      }

      /**
       * Validate signer information before submission
       * This provides client-side validation for better UX
       */
      function validateSignerInfo(signerInfo) {
        if (signerInfo.name.length < 2) {
          showAlert("Name must be at least 2 characters long", "error");
          return false;
        }

        // Basic email validation
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(signerInfo.email)) {
          showAlert("Please enter a valid email address", "error");
          return false;
        }

        // Phone validation (if provided)
        if (signerInfo.phone) {
          const phoneDigits = signerInfo.phone.replace(/\D/g, "");
          if (phoneDigits.length < 10) {
            showAlert("Phone number must be at least 10 digits", "error");
            return false;
          }
        }

        return true;
      }

      /**
       * Initialize the Dropbox Sign embedded signing experience
       * This is where the magic happens - we create the embedded signing interface
       */
      async function initializeEmbeddedSigning() {
        try {
          // Hide the form and show the signing container
          document.getElementById("signerForm").style.display = "none";
          document.getElementById("signingContainer").classList.add("active");

          // Initialize HelloSign client if not already done
          if (!appState.hellosignClient) {
            appState.hellosignClient = new window.HelloSign({
              clientId: config.clientId,
            });
          }

          // Open the signing interface
          appState.hellosignClient.open(appState.signingUrl, {
            testMode: true, // Remove this in production
            skipDomainVerification: true, // Only for development
            container: document.getElementById("signingContainer"),
            uxVersion: 2, // Use the latest UX version

            // Event handlers for different signing events
            events: {
              sign: handleSignEvent,
              cancel: handleCancelEvent,
              error: handleErrorEvent,
              close: handleCloseEvent,
              message: handleMessageEvent,
              finish: handleFinishEvent,
            },
          });

          // Start polling for status updates
          startStatusPolling();
        } catch (error) {
          console.error("Error initializing embedded signing:", error);
          showAlert("Failed to initialize signing interface", "error");
          showRetryButton();
        }
      }

      /**
       * Event Handlers for Dropbox Sign Embedded Events
       * These functions handle various events from the signing process
       */

      function handleSignEvent(data) {
        console.log("Document signed:", data);
        showAlert("Document signed successfully! Finalizing...", "success");
        updateProgress(75);
      }

      function handleCancelEvent(data) {
        console.log("Signing cancelled:", data);
        showAlert("Signing was cancelled", "info");
        appState.hellosignClient.close();
        showRetryButton();
        stopStatusPolling();
      }

      function handleErrorEvent(data) {
        console.error("Signing error:", data);
        showAlert("An error occurred during signing", "error");
        showRetryButton();
        stopStatusPolling();
      }

      function handleCloseEvent(data) {
        console.log("Signing interface closed:", data);
        // The signing interface was closed (either completed or cancelled)
        checkFinalStatus();
      }

      function handleMessageEvent(data) {
        console.log("Message from signing interface:", data);
        // Handle any custom messages from the signing interface
      }

      function handleFinishEvent(data) {
        console.log("Signing process finished:", data);
        updateProgress(90);
        checkFinalStatus();
      }

      /**
       * Start polling for status updates
       * This provides real-time feedback on the signing progress
       */
      function startStatusPolling() {
        // Show status container
        document.getElementById("statusContainer").classList.add("active");
        updateStatusDisplay("pending", "Waiting for signature...");
        updateProgress(25);

        appState.pollCount = 0;
        appState.statusPoller = setInterval(async () => {
          appState.pollCount++;

          // Stop polling after max attempts
          if (appState.pollCount > config.maxPollAttempts) {
            stopStatusPolling();
            showAlert(
              "Status check timed out. Please refresh the page.",
              "error"
            );
            return;
          }

          try {
            const response = await fetch(
              `${config.backendUrl}/signing-status/${appState.sessionId}`
            );
            if (!response.ok) {
              throw new Error("Failed to fetch status");
            }

            const status = await response.json();
            handleStatusUpdate(status);
          } catch (error) {
            console.error("Error fetching status:", error);
          }
        }, config.pollInterval);
      }

      /**
       * Stop polling for status updates
       */
      function stopStatusPolling() {
        if (appState.statusPoller) {
          clearInterval(appState.statusPoller);
          appState.statusPoller = null;
        }
      }

      /**
       * Handle status updates from the backend
       * This updates the UI based on the current signing status
       */
      function handleStatusUpdate(status) {
        console.log("Status update:", status);

        switch (status.status) {
          case "completed":
            stopStatusPolling();
            updateStatusDisplay("completed", "Document signed successfully!");
            updateProgress(100);
            showDownloadButton();
            // Close the signing interface if still open
            if (appState.hellosignClient) {
              appState.hellosignClient.close();
            }
            break;

          case "declined":
            stopStatusPolling();
            updateStatusDisplay("declined", "Signing was declined");
            updateProgress(0);
            showRetryButton();
            break;

          case "voided":
            stopStatusPolling();
            updateStatusDisplay("voided", "Document was cancelled");
            updateProgress(0);
            showRetryButton();
            break;

          case "sent":
          case "delivered":
            // Still in progress
            updateProgress(50);
            break;
        }
      }

      /**
       * Check the final status after signing interface is closed
       */
      async function checkFinalStatus() {
        try {
          const response = await fetch(
            `${config.backendUrl}/signing-status/${appState.sessionId}`
          );
          if (response.ok) {
            const status = await response.json();
            handleStatusUpdate(status);
          }
        } catch (error) {
          console.error("Error checking final status:", error);
        }
      }

      /**
       * Update the status display with appropriate icon and message
       */
      function updateStatusDisplay(status, message) {
        const statusContent = document.getElementById("statusContent");

        const icons = {
          pending: "‚è≥",
          completed: "‚úÖ",
          declined: "‚ùå",
          voided: "üö´",
          error: "‚ö†Ô∏è",
        };

        statusContent.innerHTML = `
                <div class="status-icon">${icons[status] || "üìÑ"}</div>
                <div class="status-message">${message}</div>
                <div class="status-details">Session ID: ${
                  appState.sessionId || "N/A"
                }</div>
            `;
      }

      /**
       * Update the progress bar
       */
      function updateProgress(percentage) {
        const progressBar = document.getElementById("progressBar");
        progressBar.style.width = `${percentage}%`;
      }

      /**
       * Show download button for completed documents
       */
      function showDownloadButton() {
        const statusContent = document.getElementById("statusContent");
        const downloadBtn = document.createElement("button");
        downloadBtn.className = "btn btn-success";
        downloadBtn.textContent = "üì• Download Signed Document";
        downloadBtn.onclick = downloadDocument;
        statusContent.appendChild(downloadBtn);
      }

      /**
       * Show retry button for failed or cancelled attempts
       */
      function showRetryButton() {
        const statusContent = document.getElementById("statusContent");
        const retryBtn = document.createElement("button");
        retryBtn.className = "btn btn-secondary";
        retryBtn.textContent = "üîÑ Try Again";
        retryBtn.onclick = resetForm;
        statusContent.appendChild(retryBtn);
      }

      /**
       * Download the signed document
       */
      async function downloadDocument() {
        try {
          showAlert("Downloading document...", "info");

          const response = await fetch(
            `${config.backendUrl}/download-document/${appState.sessionId}`
          );
          if (!response.ok) {
            throw new Error("Failed to download document");
          }

          // Create a blob from the response
          const blob = await response.blob();

          // Create a download link
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = `signed_document_${appState.sessionId}.pdf`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          window.URL.revokeObjectURL(url);

          showAlert("Document downloaded successfully!", "success");
        } catch (error) {
          console.error("Error downloading document:", error);
          showAlert("Failed to download document", "error");
        }
      }

      /**
       * Reset the form to start over
       */
      function resetForm() {
        // Reset state
        appState = {
          sessionId: null,
          envelopeId: null,
          signingUrl: null,
          pollCount: 0,
          statusPoller: null,
          hellosignClient: appState.hellosignClient, // Keep the client instance
        };

        // Reset UI
        document.getElementById("signerForm").style.display = "block";
        document.getElementById("signingContainer").classList.remove("active");
        document.getElementById("statusContainer").classList.remove("active");
        document.getElementById("signingForm").reset();

        // Clear any alerts
        document.getElementById("alertContainer").innerHTML = "";

        // Reset progress
        updateProgress(0);

        // Enable form
        setFormEnabled(true);
      }

      /**
       * Enable or disable form inputs
       */
      function setFormEnabled(enabled) {
        const form = document.getElementById("signingForm");
        const inputs = form.querySelectorAll("input, button");
        inputs.forEach((input) => {
          input.disabled = !enabled;
        });
      }

      /**
       * Initialize the application when the page loads
       */
      document.addEventListener("DOMContentLoaded", function () {
        console.log("Document Signing Portal initialized");

        // Add input formatting for phone number
        const phoneInput = document.getElementById("phone");
        phoneInput.addEventListener("input", function (e) {
          let value = e.target.value.replace(/\D/g, "");
          if (value.length >= 6) {
            value =
              value.slice(0, 3) +
              "-" +
              value.slice(3, 6) +
              "-" +
              value.slice(6, 10);
          } else if (value.length >= 3) {
            value = value.slice(0, 3) + "-" + value.slice(3);
          }
          e.target.value = value;
        });

        // Optionally removed: URL-based clientId check, now handled by backend response
        // const urlParams = new URLSearchParams(window.location.search);
        // const clientId = urlParams.get("client_id");
        // if (clientId) {
        //   config.clientId = clientId;
        //   console.log("Client ID set from URL parameters");
        // }
      });

      /**
       * Handle window unload to clean up resources
       */
      window.addEventListener("beforeunload", function () {
        stopStatusPolling();
        if (appState.hellosignClient) {
          appState.hellosignClient.close();
        }
      });
    </script>
  </body>
</html>
